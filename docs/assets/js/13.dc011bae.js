(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{379:function(e,t,r){"use strict";r.r(t);var n=r(44),a=Object(n.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"lineage-2-authorization-procedure"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#lineage-2-authorization-procedure"}},[e._v("#")]),e._v(" Lineage 2 Authorization Procedure")]),e._v(" "),r("blockquote",[r("p",[e._v("Two servers - an "),r("code",[e._v("authorization server")]),e._v(" and a "),r("code",[e._v("game server")]),e._v(". Each of them encrypts packets for the client in a slightly different way.")])]),e._v(" "),r("h2",{attrs:{id:"general-information"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#general-information"}},[e._v("#")]),e._v(" General Information")]),e._v(" "),r("ul",[r("li",[e._v("Packets are byte arrays")]),e._v(" "),r("li",[e._v("Bytes arrive and are written in the reverse order to a TCP socket (see Little Endian)")]),e._v(" "),r("li",[e._v("Packets consist of length (2 bytes), packet type (1 byte) and content (any number of bytes)")]),e._v(" "),r("li",[e._v("The contents of the packet will be called the data transmitted in the packet (keys, session ID, etc.), excluding the length and type of packet")]),e._v(" "),r("li",[e._v("The length of the packet is not encrypted and is not taken into account when calculating the checksum, since it is calculated after. The type of package, as well as the contents, is taken into account when calculating the checksum. The packet type, contents and checksum are encrypted together using the Blowfish algorithm.")]),e._v(" "),r("li",[e._v("Packet Length - A number indicating the length of the entire packet. In other words, it also includes the length of the encrypted data (which consists of the contents and type of the packet, the checksum and is encrypted using the Blowfish algorithm) and two bytes for the number itself, indicating the length")]),e._v(" "),r("li",[e._v("Blowfish is a block cipher algorithm that processes blocks of 8 bytes each, which means that the length of the contents of the packet together with the type and checksum must be a multiple of 8 (for this, the checksum is beaten from the contents of the packet with the required number of zeros)")]),e._v(" "),r("li",[e._v("Please note that depending on whether you collect the package in advance in Little Endian order or later deploy the encryption and checksum calculation algorithms, respectively, it will be different.\nThis may be important if, for example, the library selected for your programming language Blowfish can only encrypt bytes in direct order (Big Endian)")])]),e._v(" "),r("h2",{attrs:{id:"the-order-of-interaction-of-the-authorization-server-with-the-client"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#the-order-of-interaction-of-the-authorization-server-with-the-client"}},[e._v("#")]),e._v(" The order of interaction of the authorization server with the client")]),e._v(" "),r("p",[e._v("For convenience, I'll denote by the prefix "),r("code",[e._v("S")]),e._v(" packets sent by the server, and "),r("code",[e._v("C")]),e._v(" - sent by the client, because they can have the same ID, but different contents")]),e._v(" "),r("blockquote",[r("p",[e._v("S / 0x00 (Init) packet is not signed by the checksum, all other packets are signed by")])]),e._v(" "),r("blockquote",[r("p",[e._v("S / 0x00 (Init) is encrypted using the XOR algorithm, all other packets are not encrypted.")])]),e._v(" "),r("p",[e._v("All packets are encrypted using the Blowfish algorithm with a key randomly generated for each connection and sent in the S / 0x00 (Init) packet, except for the S / 0x00 (Init) packet which is encrypted with a key invented by the developers of the game (wired in the client)")]),e._v(" "),r("p",[e._v("Encryption using the Blowfish algorithm is always the last, i.e.:")]),e._v(" "),r("div",{staticClass:"language-meta extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# S / 0x00 packet encryption (Init)\ndata = xor.encrypt (data)\ndata = blowfish.encrypt (data, STATIC_KEY)\n\n# Encryption of any other package\ndata = checksum.sign (data)\ndata = blowfish.encrypt (data, SESSION_KEY)\n")])])]),r("p",[e._v("Decryption always goes the same:")]),e._v(" "),r("div",{staticClass:"language-meta extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# Decryption of any incoming packet\ndata = blowfish.decrypt (data, SESSION_KEY)\ndata = checksum.verify (data)\n")])])]),r("p",[e._v("The contents of the C / 0x00 packet (RequestAuthLogin) comes with the RSA encrypted algorithm using the key that the server sends in the S / 0x00 (Init) packet. Only content is encrypted, but not the length or type of the packet. The packet itself is encrypted as usual. The content is encrypted additionally, as contains login and password")]),e._v(" "),r("p",[e._v("Interaction procedure for successful authorization:")]),e._v(" "),r("ol",[r("li",[r("em",[e._v("User initializes the client with login and password")])]),e._v(" "),r("li",[e._v("Client connects to a server (default socket port 2106)")]),e._v(" "),r("li",[e._v("Server sends "),r("code",[e._v("S / 0x00")]),e._v(" packet ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/Init.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("Init"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("Client sends "),r("code",[e._v("C / 0x07")]),e._v(" packet ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/AuthGameGuard.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("AuthGameGuard"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("Server sends "),r("code",[e._v("S / 0x0b")]),e._v(" packet ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/GGAuth.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("GGAuth"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("Client sends username and password in "),r("code",[e._v("C / 0x00")]),e._v(" packet ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/RequestAuthLogin.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("RequestAuthLogin"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("The server checks the username and password and sends "),r("code",[e._v("S / 0x03")]),e._v(" ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/LoginOk.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("LoginOk"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("The client requests a list of game servers with the "),r("code",[e._v("C / 0x05")]),e._v(" package ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/RequestServerList.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("RequestServerList"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("The server sends a list of game servers in the "),r("code",[e._v("S / 0x04")]),e._v(" package ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/ServerList.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("ServerList"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("The client selects a server from the list, and sends a "),r("code",[e._v("C / 0x02")]),e._v(" packet ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/RequestServerLogin.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("RequestServerLogin"),r("OutboundLink")],1),e._v(")")]),e._v(" "),r("li",[e._v("Server sends packet "),r("code",[e._v("S / 0x07")]),e._v(" ("),r("a",{attrs:{href:"https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/PlayOk.ts",target:"_blank",rel:"noopener noreferrer"}},[e._v("PlayOK"),r("OutboundLink")],1),e._v(")")])]),e._v(" "),r("p",[e._v("Next, the client disconnects from the authorization server and connects to the game server.")]),e._v(" "),r("h2",{attrs:{id:"sending-packets-by-the-authorization-server"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#sending-packets-by-the-authorization-server"}},[e._v("#")]),e._v(" Sending packets by the authorization server.")]),e._v(" "),r("p",[e._v("Packets are written as an array of bytes:")]),e._v(" "),r("ol",[r("li",[e._v("Write 1 byte of packet type, for example, 0x00")]),e._v(" "),r("li",[e._v("We form and add the contents of the package (session ID, server version, keys, zero-byte of Blowfish key end, etc.)")]),e._v(" "),r("li",[e._v("We calculate the checksum for the current byte array")]),e._v(" "),r("li",[e._v("We achieve the length of the current byte array with zero bytes up to a multiple of 8")]),e._v(" "),r("li",[e._v("Add the checksum to the array")]),e._v(" "),r("li",[e._v("We encrypt the current byte array using the Blowfish algorithm")]),e._v(" "),r("li",[e._v("Calculate the length of the resulting array")]),e._v(" "),r("li",[e._v("We add to the value of length 2 to take into account the two bytes of length themselves")]),e._v(" "),r("li",[e._v("Add the length to the beginning of the array")])]),e._v(" "),r("p",[r("em",[e._v("From a TCP socket, bytes should be read in reverse order.")])])])}),[],!1,null,null,null);t.default=a.exports}}]);